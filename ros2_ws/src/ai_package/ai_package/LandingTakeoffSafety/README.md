# landing-takeoff-safety

## Краткое описание

Программный модуль анализа данных для обеспечения безопасности в зоне взлёта / посадки на основе технического зрения и искусственного интеллекта.

Формат результирующего json-файла:

```json
[
    {
        "file": "path/to/file",
        "frame_idx": ...,
        "detections": [
            [
                ...,
                ...,
                ...,
                ...
            ]
        ],
        "scenario": "..."
    },
    ...
]
```

Данные:

* file – путь до файла, с которого взят кадр;
* frame_idx – id кадра в данном файле;
* detections: координаты прямоугольника в котором находится
  распознанный объект;
* scenario: сценарий для данной ситуации.

## Требования для запуска

* Python: версия 3.10
* Операционная система: Windows, Linux, macOS
* Архитектура: arm64 (с PyTorch 2.5.0)
* Память: минимум 4 ГБ RAM
* Видеокарта: опционально для ускорения (CUDA-совместимая)

## Установка и запуск

1. Установите Python.
2. Загрузите репозиторий программного модуля.
3. Создайте виртуальное окружение ``python -m venv lts-venv`` и активируйте ``source lts-venv/bin/activate``
4. Установите требуемые библиотеки через команду, запущенную из директории с репозиторием: ``pip install -r requirements.txt``.
5. Запустите программный модуль через команду, указав необходимые аргументы. Пример:  

   ```
   python main.py --data_type --data test_data --roi "0,0,150,150" --output_path runs/run1.json --weights_path weights/yolov10s.pt  --visualization
   ```  

Установка с [conda](https://www.anaconda.com/download/):  
1. `conda create -n lts python=3.10` - создание conda-окружения с рекомендуемой версией Python.
2. `conda activate lts` - активация conda-окружения.
3. `git clone https://github.com/pavaliew/landing-takeoff-safety.git` - загрузка репозитория с помощью Git.
4. `cd landing-takeoff-safety` - переход к директории программного модуля.
5. `pip install -r requirements.txt` - установка требуемых библиотек для Python.
6. `touch runs/run1.json` - создание файла, где будут сохранены результаты работы программы.
7. `python main.py --data_type --data test_data --roi "0,0,150,150" --output_path runs/run1.json --weights_path weights/yolov10s.pt --visualization` - запуск программного модуля.

## Описание аргументов при запуске

* `--data_type` - тип входных данных: если указан при запуске как `python main.py --data_type`, то будут анализироваться файл с форматом PNG/BMP/TIFF/JPEG/MP4/AVI или директория с файлами определенных форматов по пути, прописанном в аргументе `--data`; если параметр не указан, то программа будет анализировать видеопоток в реальном времени с устройства (посадочной камеры), номер которого (начиная с 0) в аргументе `--data`.
* `--data` -  расположение директории с видеофайлами/изображениями или номер устройства (посадочной камеры), с которого будет анализироваться видеопоток. Пример:  

  ```
  python main.py --data 0
  ```
* `--weights_path` - расположение весов модели, поддерживаемой библиотекой Ultralytics. Пример:  

  ```
  python main.py --weights_path path/to/weights.pt
  ```
* `--roi` - границы области интереса кадра, задаваемые как левая верхняя точка прямоугольника и его высота и ширина. Значения указываются в формате (без пробелов): “x,y,width,height”. Пример:  

  ```
  python main.py --roi "0,0,200,200"
  ```
* `--output_path` - расположение JSON-файла, в который будет записано описание обнаруженных объектов в зоне
  взлета / посадки и сценарий безопасного полета. Пример:  

  ```
  python main.py --output_path run1.json
  ```

* `--visualization` - включение визуализации OpenCV. Визуализация включена всегда, если программный модуль использует видеопоток с камеры.

* `--video_output_path` - расположение mp4-файла, в который будет записано видео обнаружения объектов в зоне взлета / посадки. Пример:  

  ```
  python main.py --video_output_path video.mp4
  ```

## Работа с модулем

Модуль поддерживает два режима работы:
1. Анализ видеофайлов, изображений, наборов изображений и/или видеофайлов, содержащихся в директории, расположение которой в аргументе data. **Особенности работы**:  
   1.1. Поддерживает PNG, BMP, TIFF, JPEG, MP4, AVI-файлы.  
   1.2. Для включения требуется в команде запуска указать флаг --data_type.  
   1.3. Результаты анализа введенных данных записываются в json-файл после анализа всех данных.  
3. Анализ видеопотока с посадочной web-/usb-камеры в реальном времени. **Особенности работы**:  
2.1. Всегда включена визуализация через OpenCV.  
2.2. Для включения требуется не указывать флаг --data_type.  
2.3. При нажатии q или ESC в терминале произойдёт сохранение результатов и завершение работы программного модуля.  

Рекомендации по настройке ROI:
* Используйте минимально необходимую область для ускорения обработки.
* Избегайте областей с большим количеством движения (если не требуется).

## Тестовые сценарии

Перед тестовыми сценариями обязательно включите виртуальное окружение: ``source lts-venv/bin/activate``

**1. Базовая функциональность:**   
```
python main.py --data_type --data test_data/sample.jpg --roi "0,0,300,300" --output_path runs/test1.json --weights_path weights/yolov10s.pt --visualization
```  
Результат: Окно с визуализацией, JSON-файл с результатами детекции.

**2. Пакетная обработка:**  
```
python main.py --data_type --data test_data --roi "100,100,540,540" --output_path runs/batch_test.json --weights_path weights/yolov10s.pt
```  
Ожидаемый результат: JSON-файл с результатами для всех изображений в директории.

**3. Анализ видеопотока:**  
```
python main.py --data 0 --roi "0,0,640,640" --output_path runs/video_test.json --weights_path weights/yolov10s.pt --visualization
```
Ожидаемый результат: Воспроизведение видео с детекциями, JSON с результатами по кадрам.

## Устранение неполадок

Ошибка "Unable to load image".   
Решение: Проверьте путь к файлу и поддерживаемый формат.   

Ошибка "Unable to open video source".  
Решение: Убедитесь, что видеофайл не поврежден и поддерживается OpenCV.  

Ошибка "Unable to open device"  
Решение:
* Проверьте подключение камеры.
* Попробуйте другой индекс устройства (0, 1, 2...).
* Убедитесь, что камера не используется другим приложением.
